---
/**
 * Credit Card Comparison Page
 * Compare and find the best credit cards in Singapore
 */

import Base from "@/layouts/Base.astro";
import { generatePaths } from "@/lib/utils/i18nUtils";
import CreditCardHero from "@/components/sections/CreditCardHero.astro";
import FilterSidebar from "@/components/widgets/FilterSidebar.astro";
import PromotionBanner from "@/components/widgets/PromotionBanner.astro";
import CreditCardItem from "@/components/cards/CreditCardItem.astro";
import SortDropdown from "@/components/widgets/SortDropdown.astro";

// Import credit card data
import creditCardsData from "@/data/credit-cards.json";

export function getStaticPaths() {
  return generatePaths();
}

// Page metadata
const pageData = {
  title: "Credit Card Comparison - Find the Best Cards 2025",
  meta_title: "Compare the Best Credit Cards in Singapore 2025",
  description:
    "Compare and find your ideal credit card with our easy-to-use comparison tool. Discover the best rewards, cashback, and travel cards in Singapore.",
  image: "/images/credit-cards-og.jpg",
};

// Get all credit cards from JSON
const allCreditCards = creditCardsData.cards;
---

<Base {...pageData}>
  <CreditCardHero />

  <!-- Main Content Area -->
  <section class="py-12 md:py-16">
    <div class="container">
      <div class="flex flex-col gap-8 lg:flex-row lg:gap-12">
        <!-- Sidebar Filters -->
        <div class="lg:w-72 lg:flex-shrink-0">
          <FilterSidebar />
        </div>

        <!-- Credit Card Listings -->
        <div class="flex-1 space-y-8">
          <!-- Results Count and Sort -->
          <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <h2 id="results-count" class="text-2xl font-bold text-dark">
              We found {allCreditCards.length} credit cards for you!
            </h2>
            <div class="sm:w-64">
              <SortDropdown />
            </div>
          </div>

          <!-- Promotion Banner -->
          <PromotionBanner
            text="Get $400 Cash or Apple iPad + Latest Apple iPhone 17 Pro"
            endDate="5 days"
          />

          <!-- Credit Card List -->
          <div id="card-list" class="space-y-6">
            {allCreditCards.map((card) => <CreditCardItem {...card} />)}
          </div>

          <!-- No Results Message (hidden by default) -->
          <div id="no-results" class="hidden rounded-lg bg-gray-100 p-8 text-center">
            <div data-lucide="search-x" class="mx-auto mb-4 h-16 w-16 text-gray-400"></div>
            <h3 class="mb-2 text-xl font-bold text-dark">No cards found</h3>
            <p class="text-gray-600">Try adjusting your filters to see more results.</p>
          </div>

          <!-- Load More (hidden when using filters) -->
          <div id="load-more-section" class="flex justify-center pt-8">
            <button
              type="button"
              class="btn btn-outline btn-md hover:bg-primary hover:text-white hover:border-primary"
            >
              Load More Cards
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>
</Base>

<script define:vars={{ allCreditCards }}>
  // Credit Card Filtering and Sorting System
  document.addEventListener("DOMContentLoaded", () => {
    let cards = [...allCreditCards];
    let currentFilters = {
      promotions: [],
      "card-association": [],
      providers: "all-providers",
      category: "all",
    };
    let currentSort = "featured";

    // Get DOM elements
    const cardList = document.getElementById("card-list");
    const resultsCount = document.getElementById("results-count");
    const noResults = document.getElementById("no-results");
    const sortSelect = document.getElementById("sort-select");
    const filterInputs = document.querySelectorAll(".filter-input");
    const categoryButtons = document.querySelectorAll(".category-filter-btn");

    // Initialize filters
    filterInputs.forEach((input) => {
      input.addEventListener("change", handleFilterChange);
    });

    // Initialize sort
    if (sortSelect) {
      sortSelect.addEventListener("change", handleSortChange);
    }

    // Initialize category buttons
    categoryButtons.forEach((button) => {
      button.addEventListener("click", handleCategoryClick);
    });

    function handleFilterChange(event) {
      const filterType = event.target.dataset.filterType;
      const filterValue = event.target.dataset.filterValue;
      const isChecked = event.target.checked;

      if (event.target.type === "checkbox") {
        // Handle checkbox filters (promotions, card-association)
        if (isChecked) {
          if (!currentFilters[filterType].includes(filterValue)) {
            currentFilters[filterType].push(filterValue);
          }
        } else {
          currentFilters[filterType] = currentFilters[filterType].filter(
            (v) => v !== filterValue
          );
        }
      } else if (event.target.type === "radio") {
        // Handle radio filters (providers)
        currentFilters[filterType] = filterValue;
      }

      applyFiltersAndSort();
    }

    function handleSortChange(event) {
      currentSort = event.target.value;
      applyFiltersAndSort();
    }

    function handleCategoryClick(event) {
      const category = event.currentTarget.dataset.category;
      if (!category) return;

      // Update active state on buttons
      categoryButtons.forEach((btn) => {
        if (btn.dataset.category === category) {
          btn.classList.add("active", "border-white", "bg-white", "text-dark");
          btn.classList.remove("border-white/40", "bg-transparent", "text-white");
        } else {
          btn.classList.remove("active", "border-white", "bg-white", "text-dark");
          btn.classList.add("border-white/40", "bg-transparent", "text-white");
        }
      });

      // Update filter
      currentFilters.category = category;
      applyFiltersAndSort();

      // Smooth scroll to results
      if (cardList) {
        const offset = 100;
        const elementPosition = cardList.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.pageYOffset - offset;

        window.scrollTo({
          top: offsetPosition,
          behavior: "smooth",
        });
      }
    }

    function applyFiltersAndSort() {
      // Start with all cards
      let filteredCards = [...allCreditCards];

      // Apply promotion filters
      if (currentFilters.promotions.length > 0) {
        filteredCards = filteredCards.filter((card) => {
          return currentFilters.promotions.some((promo) =>
            card.promotions?.includes(promo)
          );
        });
      }

      // Apply card association filters
      if (currentFilters["card-association"].length > 0) {
        filteredCards = filteredCards.filter((card) => {
          return currentFilters["card-association"].some((assoc) =>
            card.cardAssociation?.includes(assoc)
          );
        });
      }

      // Apply provider filter
      if (currentFilters.providers !== "all-providers") {
        filteredCards = filteredCards.filter(
          (card) => card.provider === currentFilters.providers
        );
      }

      // Apply category filter
      if (currentFilters.category !== "all") {
        filteredCards = filteredCards.filter(
          (card) => card.category === currentFilters.category
        );
      }

      // Apply sorting
      filteredCards = sortCards(filteredCards, currentSort);

      // Update the display
      renderCards(filteredCards);
    }

    function sortCards(cardsToSort, sortType) {
      const sorted = [...cardsToSort];

      switch (sortType) {
        case "featured":
          return sorted.sort((a, b) => (b.featured ? 1 : 0) - (a.featured ? 1 : 0));

        case "rating-high":
          return sorted.sort((a, b) => (b.rating || 0) - (a.rating || 0));

        case "rating-low":
          return sorted.sort((a, b) => (a.rating || 0) - (b.rating || 0));

        case "fee-low":
          return sorted.sort((a, b) => (a.annualFee || 0) - (b.annualFee || 0));

        case "fee-high":
          return sorted.sort((a, b) => (b.annualFee || 0) - (a.annualFee || 0));

        case "name-az":
          return sorted.sort((a, b) => a.cardName.localeCompare(b.cardName));

        case "name-za":
          return sorted.sort((a, b) => b.cardName.localeCompare(a.cardName));

        default:
          return sorted;
      }
    }

    function renderCards(cardsToRender) {
      // Update results count
      if (resultsCount) {
        resultsCount.textContent = `We found ${cardsToRender.length} credit cards for you!`;
      }

      // Show/hide no results message
      if (cardsToRender.length === 0) {
        if (cardList) cardList.style.display = "none";
        if (noResults) noResults.classList.remove("hidden");
      } else {
        if (cardList) cardList.style.display = "block";
        if (noResults) noResults.classList.add("hidden");

        // Render cards
        if (cardList) {
          cardList.innerHTML = cardsToRender
            .map((card) => createCardHTML(card))
            .join("");
        }
      }

      // Re-initialize Lucide icons for dynamically added content
      if (window.lucide) {
        window.lucide.createIcons();
      }
    }

    function createCardHTML(card) {
      const badgesHTML = card.badges
        ? card.badges
            .map(
              (badge) =>
                `<span class="inline-block rounded bg-yellow-400 px-3 py-1 text-xs font-bold uppercase text-gray-900">${badge}</span>`
            )
            .join("")
        : "";

      const offersHTML =
        card.offers && card.offers.length > 0
          ? `
        <div class="mb-6">
          <p class="mb-4 font-semibold text-dark">Apply now and redeem any of these:</p>
          <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            ${card.offers
              .map(
                (offer) => `
              <div class="offer-card group relative overflow-hidden rounded-lg border-2 border-gray-200 bg-gradient-to-br from-emerald-600 to-teal-600 p-4 text-white transition-all duration-300 hover:shadow-lg">
                ${
                  offer.badge
                    ? `<span class="mb-2 inline-block rounded bg-green-500 px-2 py-1 text-xs font-semibold uppercase">${offer.badge}</span>`
                    : ""
                }
                ${
                  offer.image
                    ? `<div class="mb-3 flex items-center justify-center"><img src="${offer.image}" alt="${offer.title}" class="h-20 w-20 object-contain" /></div>`
                    : ""
                }
                ${
                  offer.icon
                    ? `<div class="mb-3 flex items-center justify-center"><div data-lucide="${offer.icon}" class="h-16 w-16"></div></div>`
                    : ""
                }
                <h4 class="mb-1 text-sm font-bold">${offer.title}</h4>
                ${offer.points ? `<p class="text-xs opacity-90">${offer.points}</p>` : ""}
              </div>
            `
              )
              .join("")}
          </div>
        </div>
      `
          : "";

      const promotionHTML = card.promotionDetails
        ? `
        <div class="rounded-lg bg-green-50 p-4 border-2 border-green-100">
          <p class="text-sm text-gray-700">${card.promotionDetails}</p>
          ${
            card.promotionExpiry
              ? `<p class="mt-2 text-xs font-semibold text-gray-600">Valid till ${card.promotionExpiry}</p>`
              : ""
          }
        </div>
      `
        : "";

      return `
        <div class="credit-card-item rounded-xl border-2 border-gray-200 bg-white p-6 shadow-sm transition-shadow duration-300 hover:shadow-lg">
          ${badgesHTML ? `<div class="mb-4 flex flex-wrap gap-2">${badgesHTML}</div>` : ""}

          <div class="mb-6 flex flex-col gap-6 md:flex-row md:items-start md:justify-between">
            <div class="flex items-center gap-4">
              <div class="h-24 w-36 flex-shrink-0 overflow-hidden rounded-lg bg-gray-100">
                <img src="${card.cardImage}" alt="${card.cardName}" class="h-full w-full object-cover" />
              </div>
              <div>
                <h3 class="mb-1 text-xl font-bold text-dark">${card.cardName}</h3>
                <p class="text-sm text-gray-600">${card.bankName}</p>
              </div>
            </div>

            <div class="flex flex-wrap gap-4 md:flex-1 md:justify-center">
              <div class="reward-info flex-1 min-w-[180px] rounded-lg bg-gray-50 p-4">
                <p class="mb-1 text-2xl font-bold text-primary">${card.primaryReward.rate}</p>
                <p class="text-xs text-gray-600">${card.primaryReward.description}</p>
              </div>
              ${
                card.secondaryReward
                  ? `<div class="reward-info flex-1 min-w-[180px] rounded-lg bg-gray-50 p-4">
                <p class="mb-1 text-2xl font-bold text-dark">${card.secondaryReward.rate}</p>
                <p class="text-xs text-gray-600">${card.secondaryReward.description}</p>
              </div>`
                  : ""
              }
              ${
                card.tertiaryReward
                  ? `<div class="reward-info flex-1 min-w-[180px] rounded-lg bg-gray-50 p-4">
                <p class="mb-1 text-2xl font-bold text-primary">${card.tertiaryReward.rate}</p>
                <p class="text-xs text-gray-600">${card.tertiaryReward.description}</p>
              </div>`
                  : ""
              }
            </div>

            <div class="flex flex-col items-start gap-2 md:items-end">
              <a href="${card.applyUrl}" target="_blank" rel="noopener noreferrer" class="btn-apply">Apply Now</a>
              <p class="text-xs text-gray-500">on ${card.bankName}'s secure site</p>
            </div>
          </div>

          ${offersHTML}
          ${promotionHTML}

          <div class="mt-4 space-y-2">
            <details class="group">
              <summary class="flex cursor-pointer items-center justify-between rounded-lg bg-gray-50 px-4 py-3 font-semibold text-dark transition-colors hover:bg-gray-100">
                <span class="flex items-center gap-2">
                  <div data-lucide="gift" class="h-5 w-5"></div>
                  Reward Details
                </span>
                <div data-lucide="chevron-down" class="h-5 w-5 transition-transform group-open:rotate-180"></div>
              </summary>
              <div class="mt-2 rounded-lg border-2 border-gray-100 bg-white p-4">
                <p class="text-sm text-gray-700">Detailed reward information will be displayed here...</p>
              </div>
            </details>

            <details class="group">
              <summary class="flex cursor-pointer items-center justify-between rounded-lg bg-gray-50 px-4 py-3 font-semibold text-dark transition-colors hover:bg-gray-100">
                <span class="flex items-center gap-2">
                  <div data-lucide="credit-card" class="h-5 w-5"></div>
                  Card Details
                </span>
                <div data-lucide="chevron-down" class="h-5 w-5 transition-transform group-open:rotate-180"></div>
              </summary>
              <div class="mt-2 rounded-lg border-2 border-gray-100 bg-white p-4">
                <p class="text-sm text-gray-700">Card specifications and requirements will be displayed here...</p>
              </div>
            </details>
          </div>
        </div>
      `;
    }

    // Initial render with default sort (featured)
    applyFiltersAndSort();
  });
</script>
