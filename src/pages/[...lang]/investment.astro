---
/**
 * Investment Comparison Page
 * Compare and find the best investment brokerages in Singapore
 */

import Base from "@/layouts/Base.astro";
import { generatePaths } from "@/lib/utils/i18nUtils";
import InvestmentHero from "@/components/sections/InvestmentHero.astro";
import InvestmentFilterSidebar from "@/components/widgets/InvestmentFilterSidebar.astro";
import InvestmentItem from "@/components/cards/InvestmentItem.astro";
import SortDropdown from "@/components/widgets/SortDropdown.astro";

// Import investment data
import investmentsData from "@/data/investments.json";

export function getStaticPaths() {
  return generatePaths();
}

// Page metadata
const pageData = {
  title: "Investment Comparison - Best Brokerages 2025",
  meta_title: "Compare the Best Investment & Online Brokerages in Singapore 2025",
  description:
    "Choose from MoneySmart's curated list of best brokerage accounts in Singapore and learn how to maximise returns by investing.",
  image: "/images/investments-og.jpg",
};

// Get all investments from JSON
const allInvestments = investmentsData.investments;
---

<Base {...pageData}>
  <InvestmentHero />

  <!-- Main Content Area -->
  <section class="py-12 md:py-16">
    <div class="container">
      <div class="flex flex-col gap-8 lg:flex-row lg:gap-12">
        <!-- Sidebar Filters -->
        <div class="lg:w-72 lg:flex-shrink-0">
          <InvestmentFilterSidebar />
        </div>

        <!-- Investment Listings -->
        <div class="flex-1 space-y-8">
          <!-- Results Count and Sort -->
          <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <h2 id="results-count" class="text-2xl font-bold text-dark">
              We found {allInvestments.length} Investments for you!
            </h2>
            <div class="sm:w-64">
              <SortDropdown />
            </div>
          </div>

          <!-- Investment List -->
          <div id="investment-list" class="space-y-6">
            {allInvestments.map((investment) => <InvestmentItem {...investment} />)}
          </div>

          <!-- No Results Message (hidden by default) -->
          <div id="no-results" class="hidden rounded-lg bg-gray-100 p-8 text-center">
            <div data-lucide="search-x" class="mx-auto mb-4 h-16 w-16 text-gray-400"></div>
            <h3 class="mb-2 text-xl font-bold text-dark">No investments found</h3>
            <p class="text-gray-600">Try adjusting your filters to see more results.</p>
          </div>

          <!-- Load More (hidden when using filters) -->
          <div id="load-more-section" class="flex justify-center pt-8">
            <button
              type="button"
              class="btn btn-outline btn-md hover:bg-primary hover:text-white hover:border-primary"
            >
              Load More Investments
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>
</Base>

<script define:vars={{ allInvestments }}>
  // Investment Filtering and Sorting System
  document.addEventListener("DOMContentLoaded", () => {
    let investments = [...allInvestments];
    let currentFilters = {
      promotions: [],
      features: [],
      provider: "all",
      category: "all",
    };
    let currentSort = "featured";

    // Get DOM elements
    const investmentList = document.getElementById("investment-list");
    const resultsCount = document.getElementById("results-count");
    const noResults = document.getElementById("no-results");
    const sortSelect = document.getElementById("sort-select");
    const filterInputs = document.querySelectorAll(".filter-input");
    const categoryButtons = document.querySelectorAll(".category-filter-btn");

    // Initialize filters
    filterInputs.forEach((input) => {
      input.addEventListener("change", handleFilterChange);
    });

    // Initialize sort
    if (sortSelect) {
      sortSelect.addEventListener("change", handleSortChange);
    }

    // Initialize category buttons
    categoryButtons.forEach((button) => {
      button.addEventListener("click", handleCategoryClick);
    });

    function handleFilterChange(event) {
      const filterType = event.target.dataset.filterType;
      const filterValue = event.target.dataset.filterValue;
      const isChecked = event.target.checked;

      if (event.target.type === "checkbox") {
        // Handle checkbox filters (promotions, features)
        if (isChecked) {
          if (!currentFilters[filterType].includes(filterValue)) {
            currentFilters[filterType].push(filterValue);
          }
        } else {
          currentFilters[filterType] = currentFilters[filterType].filter(
            (v) => v !== filterValue
          );
        }
      } else if (event.target.type === "radio") {
        // Handle radio filters (provider)
        currentFilters[filterType] = filterValue;
      }

      applyFiltersAndSort();
    }

    function handleSortChange(event) {
      currentSort = event.target.value;
      applyFiltersAndSort();
    }

    function handleCategoryClick(event) {
      const category = event.currentTarget.dataset.category;
      if (!category) return;

      // Update active state on buttons
      categoryButtons.forEach((btn) => {
        if (btn.dataset.category === category) {
          btn.classList.add("active", "border-white", "bg-white", "text-dark");
          btn.classList.remove("border-white/40", "bg-transparent", "text-white");
        } else {
          btn.classList.remove("active", "border-white", "bg-white", "text-dark");
          btn.classList.add("border-white/40", "bg-transparent", "text-white");
        }
      });

      // Update filter
      currentFilters.category = category;
      applyFiltersAndSort();

      // Smooth scroll to results
      if (investmentList) {
        const offset = 100;
        const elementPosition = investmentList.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.pageYOffset - offset;

        window.scrollTo({
          top: offsetPosition,
          behavior: "smooth",
        });
      }
    }

    function applyFiltersAndSort() {
      // Start with all investments
      let filteredInvestments = [...allInvestments];

      // Apply promotion filters
      if (currentFilters.promotions.length > 0) {
        filteredInvestments = filteredInvestments.filter((investment) => {
          return currentFilters.promotions.some((promo) =>
            investment.promotionTypes?.includes(promo)
          );
        });
      }

      // Apply feature filters
      if (currentFilters.features.length > 0) {
        filteredInvestments = filteredInvestments.filter((investment) => {
          return currentFilters.features.some((feature) =>
            investment.signUpFeatures?.includes(feature)
          );
        });
      }

      // Apply provider filter
      if (currentFilters.provider !== "all") {
        filteredInvestments = filteredInvestments.filter(
          (investment) => investment.provider === currentFilters.provider
        );
      }

      // Apply category filter
      if (currentFilters.category !== "all") {
        filteredInvestments = filteredInvestments.filter(
          (investment) => investment.category === currentFilters.category
        );
      }

      // Apply sorting
      filteredInvestments = sortInvestments(filteredInvestments, currentSort);

      // Update the display
      renderInvestments(filteredInvestments);
    }

    function sortInvestments(investmentsToSort, sortType) {
      const sorted = [...investmentsToSort];

      switch (sortType) {
        case "featured":
          return sorted.sort((a, b) => (b.featured ? 1 : 0) - (a.featured ? 1 : 0));

        case "name-az":
          return sorted.sort((a, b) => a.providerName.localeCompare(b.providerName));

        case "name-za":
          return sorted.sort((a, b) => b.providerName.localeCompare(a.providerName));

        case "recommended":
          return sorted; // Keep original order

        default:
          return sorted;
      }
    }

    function renderInvestments(investmentsToRender) {
      // Update results count
      if (resultsCount) {
        resultsCount.textContent = `We found ${investmentsToRender.length} Investments for you!`;
      }

      // Show/hide no results message
      if (investmentsToRender.length === 0) {
        if (investmentList) investmentList.style.display = "none";
        if (noResults) noResults.classList.remove("hidden");
      } else {
        if (investmentList) investmentList.style.display = "block";
        if (noResults) noResults.classList.add("hidden");

        // Render investments
        if (investmentList) {
          investmentList.innerHTML = investmentsToRender
            .map((investment) => createInvestmentHTML(investment))
            .join("");
        }
      }

      // Re-initialize Lucide icons for dynamically added content
      if (window.lucide) {
        window.lucide.createIcons();
      }
    }

    function createInvestmentHTML(investment) {
      const badgesHTML = investment.badges
        ? investment.badges
            .map((badge) => {
              const isExclusive = badge.toLowerCase().includes('exclusive');
              const badgeClass = isExclusive
                ? "bg-yellow-400 text-gray-900"
                : "bg-slate-800 text-white";
              return `<span class="inline-block rounded px-3 py-1 text-xs font-bold uppercase ${badgeClass}">${badge}</span>`;
            })
            .join("")
        : "";

      const feesHTML = investment.fees
        .map((fee) => `
          <div class="fee-detail flex-1 min-w-[180px]">
            <p class="mb-1 text-2xl font-bold text-gray-900">${fee.amount}</p>
            <p class="text-xs text-gray-600">${fee.description}${fee.note ? `<sup class="ml-0.5">${fee.note}</sup>` : ""}</p>
          </div>
        `)
        .join("");

      const rewardsHTML =
        investment.rewards && investment.rewards.length > 0
          ? `
        <div class="mb-6">
          <p class="mb-4 font-semibold text-gray-900">Apply and redeem any of these rewards</p>
          <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            ${investment.rewards
              .map(
                (reward) => `
              <div class="reward-card rounded-lg border-2 border-gray-200 bg-white p-4 text-center">
                ${
                  reward.icon
                    ? `<div class="mb-3 flex items-center justify-center"><div data-lucide="${reward.icon}" class="h-12 w-12 text-green-600"></div></div>`
                    : ""
                }
                ${
                  reward.image
                    ? `<div class="mb-3 flex items-center justify-center"><img src="${reward.image}" alt="${reward.title}" class="h-20 w-20 object-contain" /></div>`
                    : ""
                }
                <h4 class="mb-1 text-sm font-bold text-gray-900">${reward.title}</h4>
                <p class="mb-1 text-xs text-gray-600">${reward.value}</p>
                ${reward.points ? `<p class="text-xs text-gray-500">${reward.points}</p>` : ""}
              </div>
            `
              )
              .join("")}
          </div>
        </div>
      `
          : "";

      const promotionsHTML =
        investment.promotions && investment.promotions.length > 0
          ? investment.promotions
              .map((promo) => {
                const bgClass =
                  promo.type === "exclusive"
                    ? "bg-green-50 border-green-200"
                    : "bg-cyan-50 border-cyan-200";
                return `
              <div class="mt-4 rounded-lg border-2 p-4 ${bgClass}">
                <h4 class="mb-2 font-bold text-gray-900">[${promo.title}]</h4>
                <p class="mb-3 text-sm text-gray-700">${promo.description}</p>
                ${
                  promo.details && promo.details.length > 0
                    ? `<ul class="mb-3 space-y-1 text-sm text-gray-700">
                    ${promo.details.map((detail) => `<li class="flex items-start gap-2"><span class="text-green-600">â€¢</span><span>${detail}</span></li>`).join("")}
                  </ul>`
                    : ""
                }
                ${promo.validUntil ? `<p class="text-xs font-semibold text-gray-600">${promo.validUntil}</p>` : ""}
              </div>
            `;
              })
              .join("")
          : "";

      return `
        <div class="investment-item rounded-xl border-2 border-gray-200 bg-white p-6 shadow-sm transition-shadow duration-300 hover:shadow-lg">
          ${badgesHTML ? `<div class="mb-4 flex flex-wrap gap-2">${badgesHTML}</div>` : ""}

          <div class="mb-6 flex flex-col gap-6 lg:flex-row lg:items-start lg:justify-between">
            <div class="flex items-center gap-4 lg:w-48">
              <div class="flex h-20 w-20 flex-shrink-0 items-center justify-center overflow-hidden rounded-lg bg-white border-2 border-gray-100 p-2">
                <img src="${investment.providerLogo}" alt="${investment.providerName}" class="h-full w-full object-contain" />
              </div>
              <div>
                <h3 class="text-lg font-bold text-gray-900">${investment.providerName}</h3>
              </div>
            </div>

            <div class="flex flex-wrap gap-4 lg:flex-1 lg:justify-center">
              ${feesHTML}
            </div>

            <div class="flex flex-col items-start gap-2 lg:items-end lg:w-40">
              <a href="${investment.applyUrl}" target="_blank" rel="noopener noreferrer" class="btn-apply whitespace-nowrap">APPLY NOW</a>
            </div>
          </div>

          ${rewardsHTML}
          ${promotionsHTML}

          <div class="mt-4 space-y-2">
            <details class="group">
              <summary class="flex cursor-pointer items-center justify-between rounded-lg bg-gray-50 px-4 py-3 font-semibold text-gray-900 transition-colors hover:bg-gray-100">
                <span class="flex items-center gap-2">
                  <div data-lucide="info" class="h-5 w-5"></div>
                  Investment Details
                </span>
                <div data-lucide="chevron-down" class="h-5 w-5 transition-transform group-open:rotate-180"></div>
              </summary>
              <div class="mt-2 rounded-lg border-2 border-gray-100 bg-white p-4">
                <p class="text-sm text-gray-700">Detailed investment information including features, minimum funding, and available assets will be displayed here.</p>
              </div>
            </details>

            <details class="group">
              <summary class="flex cursor-pointer items-center justify-between rounded-lg bg-gray-50 px-4 py-3 font-semibold text-gray-900 transition-colors hover:bg-gray-100">
                <span class="flex items-center gap-2">
                  <div data-lucide="file-text" class="h-5 w-5"></div>
                  Sign Up Requirements
                </span>
                <div data-lucide="chevron-down" class="h-5 w-5 transition-transform group-open:rotate-180"></div>
              </summary>
              <div class="mt-2 rounded-lg border-2 border-gray-100 bg-white p-4">
                <p class="text-sm text-gray-700">Sign up requirements and account opening process will be displayed here.</p>
              </div>
            </details>
          </div>
        </div>
      `;
    }

    // Initial render with default sort (featured)
    applyFiltersAndSort();
  });
</script>
