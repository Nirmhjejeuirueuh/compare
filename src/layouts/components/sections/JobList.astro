---
import type { Section } from "@/types";
import Icons from "@/helpers/Icons.astro";
import { sortByDate } from "@/lib/utils/sortFunctions";
import { markdownify } from "@/lib/utils/textConverter";
import overrideObjects from "@/lib/utils/overrideObjects.ts";
import { getCollectionCTM, getEntryCTM } from "@/lib/contentParser.astro";
import config from ".astro/config.generated.json" with { type: "json" };
import formatRelativeDate from "@/lib/utils/formatRelativeDate";
import CustomButton from "../CustomButton.astro";
import { getLocaleUrlCTM } from "@/lib/utils/i18nUtils";
import AnimatedText from "../widgets/AnimatedText.astro";

const { careerFolder } = config.settings;

// Type for this section data
type ectionType = Section;
type Props = {
  listPage?: boolean;
  content?: ectionType;
  pagination?: {
    enable: boolean;
    currentPage: number;
  };
};

// Fetching the default content for the this section
let defaultContent = (
  await getEntryCTM(careerFolder as "career", "-index", Astro.currentLocale)
)?.data as ectionType;

// Enables content customization (e.g., title, description) with a fallback to 'defaultContent' if not provided.
// The 'content' prop should match the structure of 'defaultContent'.
// Allows using this section with different content across multiple pages.
// If 'content' is missing, 'defaultContent' will be used.
let actualContent = overrideObjects(
  { ...defaultContent },
  Astro.props.content,
) as ectionType;

// Extracting required values from 'content' object
let { enable = true, limit, title } = actualContent as ectionType;

let list = await getCollectionCTM(careerFolder as "career", Astro.currentLocale);

// Sort list by date
list = sortByDate(list);

const featuredPost = list.find((post) => post.data.featured);

// Remove featured list from the main list
if (featuredPost) {
  list = list.filter((post) => post.data.featured !== true);
}

// Limit the number of items to be displayed
if (limit) {
  list = list.slice(0, limit);
}

list = list.map((item) => {
  return {
    ...item,
    data: {
      ...item.data,
      deadline: item.data.fields?.filter(
        (field: any) => field.name.toLowerCase() === "deadline",
      )[0]?.content,
      type: item.data.fields?.filter(
        (field: any) => field.name.toLowerCase() === "type",
      )[0]?.content,
    },
  };
});

if (!enable) return;
---

<section>
  <div class="container space-y-10 md:space-y-16">
    {
      title && (
        <div class="mx-auto max-w-2xl text-center">
          <h2 class="has-italic-text capitalize">
            <AnimatedText
              delay={0.2}
              stagger={0.09}
              content={markdownify(title)}
            />
          </h2>
        </div>
      )
    }

    {
      list && (
        <div class="grid grid-cols-1 gap-8 sm:grid-cols-2 lg:grid-cols-3">
          {list.map((item, index) => (
            <div
              data-aos={
                Math.floor(index / 3) % 2 === 0
                  ? "fade-right-sm"
                  : "fade-left-sm"
              }
              data-aos-delay={((index % 3) + 1) * 100}
              class="flex flex-col items-start gap-4 border p-5 md:p-8">
              <div class="flex flex-wrap items-center gap-4">
                {item.data.type && (
                  <div class="flex items-center gap-2">
                    <Icons class="text-lg" icon="Clock7" />
                    <span set:html={item.data.type} />
                  </div>
                )}
                {item.data.deadline && (
                  <div class="flex items-center gap-2">
                    <Icons class="text-lg" icon="FileClock" />
                    <span set:html={formatRelativeDate(item.data.deadline)} />
                  </div>
                )}
              </div>
              <div class="mt-4 mb-8 space-y-3">
                {item.data.title && (
                  <h3
                    class="text-h5-sm md:text-h5 font-medium"
                    set:html={markdownify(item.data.title)}
                  />
                )}
                {item.data.excerpt && (
                  <p
                    class="opacity-80"
                    set:html={markdownify(item.data.excerpt)}
                  />
                )}
              </div>
              {item.id && (
                <CustomButton
                  class="mt-auto"
                  hoverEffect="text-flip"
                  variant="outline"
                  label="Apply Now"
                  url={getLocaleUrlCTM(
                    item.data.customSlug || item.id,
                    Astro.currentLocale,
                    careerFolder,
                  )}
                />
              )}
            </div>
          ))}
        </div>
      )
    }
  </div>
</section>
